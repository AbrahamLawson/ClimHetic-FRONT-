# ==========================================
# GITHUB ACTIONS - DÃ‰PLOIEMENT AUTOMATIQUE
# ==========================================
# Ce fichier dÃ©ploie automatiquement ton app quand tu push sur GitHub

name: ğŸš€ DÃ©ploiement ClimHetic

# Quand dÃ©clencher le dÃ©ploiement
on:
  push:
    branches: [ main ]  # Ã€ chaque push sur la branche main
  workflow_dispatch:    # Ou manuellement depuis GitHub

jobs:
  deploy:
    name: ğŸ“¦ DÃ©ployer sur le serveur
    runs-on: ubuntu-latest
    
    steps:
    # 1. RÃ©cupÃ©rer le code depuis GitHub
    - name: ğŸ“¥ RÃ©cupÃ©rer le code
      uses: actions/checkout@v4
    
    # 2. Se connecter au serveur et dÃ©ployer
    - name: ğŸš€ DÃ©ployer sur le serveur
      uses: appleboy/ssh-action@v1.0.3
      with:
        # Informations de connexion (Ã  configurer dans les secrets GitHub)
        host: admin-hetic.arcplex.tech
        username: abraham
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 2326
        
        # Commandes Ã  exÃ©cuter sur le serveur
        script: |
          echo "ğŸš€ DÃ©but du dÃ©ploiement automatique..."
          
          # ArrÃªter TOUS les conteneurs qui utilisent le port 8080
          echo "ğŸ›‘ Nettoyage complet des conteneurs..."
          docker stop $(docker ps -q --filter "publish=8080") 2>/dev/null || true
          docker rm $(docker ps -aq --filter "publish=8080") 2>/dev/null || true
          
          # Aller dans le rÃ©pertoire du projet
          cd /home/abraham/climhetic-front || {
            echo "ğŸ“ CrÃ©ation du rÃ©pertoire projet..."
            mkdir -p /home/abraham/climhetic-front
            cd /home/abraham/climhetic-front
          }
          
          # Mise Ã  jour forcÃ©e du code
          echo "ğŸ“¥ Mise Ã  jour forcÃ©e du code..."
          if [ -d ".git" ]; then
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
          else
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
            git fetch origin main
            git checkout -b main origin/main
          fi
          
          # Nettoyer les images Docker anciennes
          echo "ğŸ§¹ Nettoyage des images Docker..."
          docker system prune -f || true
          
          # Construire et lancer la nouvelle version
          echo "ğŸ”¨ Construction et lancement..."
          docker-compose -f deployment/docker-compose.yml up --build -d
          
          # Attendre que les conteneurs dÃ©marrent
          echo "â³ Attente du dÃ©marrage..."
          sleep 15
          
          # VÃ©rifier que Ã§a marche
          echo "ğŸ“Š Ã‰tat des conteneurs:"
          docker-compose -f deployment/docker-compose.yml ps
          
          echo "âœ… DÃ©ploiement automatique terminÃ© !"
          echo "ğŸŒ Application accessible sur : http://09.hetic.arcplex.dev"
