# ==========================================
# GITHUB ACTIONS - DÉPLOIEMENT AUTOMATIQUE
# ==========================================
# Ce fichier déploie automatiquement ton app quand tu push sur GitHub

name: 🚀 Déploiement ClimHetic

# Quand déclencher le déploiement
on:
  push:
    branches: [ main ]  # À chaque push sur la branche main
  workflow_dispatch:    # Ou manuellement depuis GitHub

jobs:
  deploy:
    name: 📦 Déployer sur le serveur
    runs-on: ubuntu-latest
    
    steps:
    # 1. Récupérer le code depuis GitHub
    - name: 📥 Récupérer le code
      uses: actions/checkout@v4
    
    # 2. Se connecter au serveur et déployer
    - name: 🚀 Déployer sur le serveur
      uses: appleboy/ssh-action@v1.0.3
      with:
        # Informations de connexion (à configurer dans les secrets GitHub)
        host: admin-hetic.arcplex.tech
        username: abraham
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 2326
        
        # Commandes à exécuter sur le serveur
        script: |
          echo "🚀 Début du déploiement automatique..."
          
          # Aller dans le répertoire du projet
          cd /home/abraham/climhetic-front || {
            echo "📁 Création du répertoire projet..."
            mkdir -p /home/abraham/climhetic-front
            cd /home/abraham/climhetic-front
          }
          
          # Arrêter les conteneurs Docker
          echo "🛑 Arrêt des conteneurs existants..."
          docker-compose -f deployment/docker-compose.yml down 2>/dev/null || true
          
          # Mise à jour forcée du code
          echo "📥 Mise à jour forcée du code..."
          if [ -d ".git" ]; then
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
          else
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
            git fetch origin main
            git checkout -b main origin/main
          fi
          
          # Vérifier que Docker est installé
          if ! command -v docker &> /dev/null; then
            echo "🐳 Installation de Docker..."
            sudo apt update
            sudo apt install -y docker.io docker-compose
            sudo usermod -aG docker abraham
            sudo systemctl start docker
            sudo systemctl enable docker
          fi
          
          # Vérifier que les fichiers sont présents
          echo "🔍 Vérification des fichiers..."
          ls -la deployment/
          
          # Nettoyer les images Docker anciennes
          echo "🧹 Nettoyage des images Docker..."
          docker system prune -f || true
          
          # S'assurer que l'utilisateur peut utiliser Docker
          echo "🔧 Configuration des permissions Docker..."
          sudo usermod -aG docker abraham || true
          
          # Construire et lancer la nouvelle version
          echo "🔨 Construction et lancement..."
          if ! docker-compose -f deployment/docker-compose.yml up --build -d; then
            echo "❌ Erreur lors du lancement des conteneurs"
            echo "📋 Logs d'erreur:"
            docker-compose -f deployment/docker-compose.yml logs
            exit 1
          fi
          
          # Attendre un peu que les conteneurs démarrent
          echo "⏳ Attente du démarrage des conteneurs..."
          sleep 10
          
          # Vérifier que ça marche
          echo "📊 Vérification des conteneurs..."
          docker-compose -f deployment/docker-compose.yml ps
          
          # Vérifier les logs en cas de problème
          echo "📋 Logs des conteneurs:"
          docker-compose -f deployment/docker-compose.yml logs --tail=20
          
          echo "✅ Déploiement automatique terminé !"
          echo "🌐 Application accessible sur : http://09.hetic.arcplex.dev"
