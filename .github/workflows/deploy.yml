# ==========================================
# GITHUB ACTIONS - DÃ‰PLOIEMENT AUTOMATIQUE
# ==========================================
# Ce fichier dÃ©ploie automatiquement ton app quand tu push sur GitHub

name: ğŸš€ DÃ©ploiement ClimHetic

# Quand dÃ©clencher le dÃ©ploiement
on:
  push:
    branches: [ main ]  # Ã€ chaque push sur la branche main
  workflow_dispatch:    # Ou manuellement depuis GitHub

jobs:
  deploy:
    name: ğŸ“¦ DÃ©ployer sur le serveur
    runs-on: ubuntu-latest
    
    steps:
    # 1. RÃ©cupÃ©rer le code depuis GitHub
    - name: ğŸ“¥ RÃ©cupÃ©rer le code
      uses: actions/checkout@v4
    
    # 2. Se connecter au serveur et dÃ©ployer
    - name: ğŸš€ DÃ©ployer sur le serveur
      uses: appleboy/ssh-action@v1.0.3
      with:
        # Informations de connexion (Ã  configurer dans les secrets GitHub)
        host: admin-hetic.arcplex.tech
        username: abraham
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 2326
        
        # Commandes Ã  exÃ©cuter sur le serveur
        script: |
          echo "ğŸš€ DÃ©but du dÃ©ploiement automatique..."
          
          # DÃ©finir les rÃ©pertoires de travail
          BASE_DIR="/home/abraham"
          OLD_PROJECT_DIR="/home/abraham/climhetic-front"
          NEW_PROJECT_DIR="/home/abraham/climhetic-front-new"
          
          # ArrÃªter les conteneurs Docker en cours si ils existent
          echo "ğŸ›‘ ArrÃªt des conteneurs existants..."
          cd "$OLD_PROJECT_DIR" 2>/dev/null && docker-compose -f deployment/docker-compose.yml down 2>/dev/null || true
          
          # Supprimer l'ancien rÃ©pertoire temporaire s'il existe
          sudo rm -rf "$NEW_PROJECT_DIR" 2>/dev/null || true
          
          # Cloner dans un nouveau rÃ©pertoire propre
          echo "ğŸ“¥ Clonage du code dans un rÃ©pertoire propre..."
          cd "$BASE_DIR"
          git clone https://github.com/${{ github.repository }}.git climhetic-front-new
          
          # VÃ©rifier que le clonage a rÃ©ussi
          if [ ! -d "$NEW_PROJECT_DIR" ]; then
            echo "âŒ Erreur: le clonage a Ã©chouÃ©"
            exit 1
          fi
          
          # Remplacer l'ancien rÃ©pertoire par le nouveau
          echo "ğŸ”„ Remplacement de l'ancien code..."
          sudo rm -rf "$OLD_PROJECT_DIR" 2>/dev/null || true
          
          # DÃ©placer le nouveau rÃ©pertoire
          if ! mv "$NEW_PROJECT_DIR" "$OLD_PROJECT_DIR"; then
            echo "âŒ Erreur lors du dÃ©placement du rÃ©pertoire"
            echo "ğŸ“‹ Ã‰tat des rÃ©pertoires:"
            ls -la "$BASE_DIR"
            exit 1
          fi
          
          # Aller dans le rÃ©pertoire final
          cd "$OLD_PROJECT_DIR"
          
          # VÃ©rifier qu'on est dans le bon rÃ©pertoire
          echo "ğŸ“ RÃ©pertoire actuel: $(pwd)"
          echo "ğŸ“‹ Contenu:"
          ls -la
          
          # VÃ©rifier que le code est prÃ©sent
          if [ ! -f "deployment/docker-compose.yml" ]; then
            echo "âŒ Erreur: fichier docker-compose.yml non trouvÃ©"
            echo "ğŸ“‹ Contenu du rÃ©pertoire:"
            ls -la
            exit 1
          fi
          
          # VÃ©rifier que Docker est installÃ©
          if ! command -v docker &> /dev/null; then
            echo "ğŸ³ Installation de Docker..."
            sudo apt update
            sudo apt install -y docker.io docker-compose
            sudo usermod -aG docker abraham
            sudo systemctl start docker
            sudo systemctl enable docker
          fi
          
          # VÃ©rifier que les fichiers sont prÃ©sents
          echo "ğŸ” VÃ©rification des fichiers..."
          ls -la deployment/
          
          # Nettoyer les images Docker anciennes
          echo "ğŸ§¹ Nettoyage des images Docker..."
          docker system prune -f || true
          
          # S'assurer que l'utilisateur peut utiliser Docker
          echo "ğŸ”§ Configuration des permissions Docker..."
          sudo usermod -aG docker abraham || true
          
          # Construire et lancer la nouvelle version
          echo "ğŸ”¨ Construction et lancement..."
          if ! docker-compose -f deployment/docker-compose.yml up --build -d; then
            echo "âŒ Erreur lors du lancement des conteneurs"
            echo "ğŸ“‹ Logs d'erreur:"
            docker-compose -f deployment/docker-compose.yml logs
            exit 1
          fi
          
          # Attendre un peu que les conteneurs dÃ©marrent
          echo "â³ Attente du dÃ©marrage des conteneurs..."
          sleep 10
          
          # VÃ©rifier que Ã§a marche
          echo "ğŸ“Š VÃ©rification des conteneurs..."
          docker-compose -f deployment/docker-compose.yml ps
          
          # VÃ©rifier les logs en cas de problÃ¨me
          echo "ğŸ“‹ Logs des conteneurs:"
          docker-compose -f deployment/docker-compose.yml logs --tail=20
          
          echo "âœ… DÃ©ploiement automatique terminÃ© !"
          echo "ğŸŒ Application accessible sur : http://09.hetic.arcplex.dev"
