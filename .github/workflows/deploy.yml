name: Deploy ClimHetic

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: admin-hetic.arcplex.tech
        username: abraham
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 2326
        script: |
          echo "üöÄ Starting deployment..."
          
          docker stop $(docker ps -q --filter "publish=8080") 2>/dev/null || true
          docker rm $(docker ps -aq --filter "publish=8080") 2>/dev/null || true
          
          cd /home/abraham/climhetic-front || {
            mkdir -p /home/abraham/climhetic-front
            cd /home/abraham/climhetic-front
          }
          
          if [ -d ".git" ]; then
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
          else
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
            git fetch origin main
            git checkout -b main origin/main
          fi
          
          docker system prune -f || true
          docker-compose -f deployment/docker-compose.yml up --build -d
          sleep 15
          docker-compose -f deployment/docker-compose.yml ps
          
          echo "‚úÖ Deployment complete!"
          echo "üåê App: http://09.hetic.arcplex.dev"
